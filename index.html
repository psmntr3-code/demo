<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Project Pembangunan Ruang Sekolah Minggu</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --glass:rgba(255,255,255,.7); --ring:rgba(15,23,42,.06);}
    body{ font-family:"Plus Jakarta Sans",system-ui,ui-sans-serif; }
    .card {border-radius:1rem;padding:1rem;background:var(--glass);backdrop-filter:blur(8px);border:1px solid var(--ring);}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-rose-50 via-indigo-50 to-emerald-50 text-slate-800">

<!-- Background image + soft veil -->
<div class="fixed inset-0 -z-20" style="background:url('background.jpg') center/cover no-repeat; background-attachment:fixed;"></div>
<div class="fixed inset-0 -z-10 pointer-events-none">
  <div class="absolute -top-24 -right-16 w-72 h-72 rounded-full bg-rose-200/40 blur-3xl"></div>
  <div class="absolute -bottom-24 -left-16 w-80 h-80 rounded-full bg-emerald-200/40 blur-3xl"></div>
  <div class="absolute inset-0 bg-white/60"></div>
</div>

  <header class="relative max-w-6xl mx-auto p-6">
    <div class="rounded-3xl px-6 py-5 bg-gradient-to-r from-indigo-200/60 via-sky-200/60 to-emerald-200/60 ring-1" style="--tw-ring-color: var(--ring);">
      <h1 class="text-2xl md:text-3xl font-bold">Project Pembangunan Ruang Sekolah Minggu</h1>
      <p id="lastUpdate" class="text-sm text-slate-600 mt-1">Memuat…</p>
    </div>
  </header>

  <main class="relative max-w-6xl mx-auto p-6 grid gap-6">

    <!-- Ringkasan -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="card">
        <div class="text-xs text-slate-500">Dana Diperlukan</div>
        <div id="danaTotal" class="text-xl font-semibold">...</div>
      </div>
      <div class="card">
        <div class="text-xs text-slate-500">Dana Terkumpul</div>
        <div id="totalMasuk" class="text-xl font-semibold">...</div>
      </div>
      <div class="card">
        <div class="text-xs text-slate-500">Kekurangan</div>
        <div id="kekurangan" class="text-xl font-semibold">...</div>
      </div>
      <div class="card">
        <div class="text-xs text-slate-500">Target Pertama</div>
        <div id="targetPertama" class="text-xl font-semibold">...</div>
      </div>
    </section>

    <!-- Progres total -->
    <section class="rounded-3xl p-5 bg-[var(--glass)] backdrop-blur ring-1" style="--tw-ring-color: var(--ring);">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Progres Penggalangan Dana (Total)</h2>
        <span id="totalPctText" class="text-sm text-slate-600">0%</span>
      </div>
      <div class="w-full h-3 rounded-full bg-slate-200/70 overflow-hidden">
        <div id="totalBar" class="h-3 rounded-full bg-emerald-300" style="width:0%"></div>
      </div>
      <div id="totalCaption" class="mt-2 text-xs text-slate-500">Rp 0 dari Rp 0</div>
    </section>

    <!-- Progres target pertama -->
    <section class="rounded-3xl p-5 bg-[var(--glass)] backdrop-blur ring-1" style="--tw-ring-color: var(--ring);">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Progres Target Pertama</h2>
        <span id="targetPctText" class="text-sm text-slate-600">0%</span>
      </div>
      <div class="w-full h-3 rounded-full bg-slate-200/70 overflow-hidden">
        <div id="targetBar" class="h-3 rounded-full bg-indigo-300" style="width:0%"></div>
      </div>
      <div id="targetCaption" class="mt-2 text-xs text-slate-500">Rp 0 dari Rp 0</div>
    </section>

	 <!-- Progres Janji Iman (per bulan) -->
    <section id="janjiImanSection" class="rounded-3xl p-5 bg-[var(--glass)] backdrop-blur ring-1" style="--tw-ring-color: var(--ring);">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Progres Janji Iman</h2>
        <button id="btnToggleJanjiIman" type="button"
                class="flex items-center gap-1 text-xs text-slate-600 hover:text-slate-800">
          <span id="janjiImanToggleText">Tampilkan semua bulan</span>
          <svg id="janjiImanToggleIcon" class="w-3 h-3 transition-transform" viewBox="0 0 20 20" fill="none"
               xmlns="http://www.w3.org/2000/svg">
            <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="1.5"
                  stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <!-- hanya bulan terakhir (default) -->
      <div id="janjiImanSingle" class="space-y-2 text-xs">
        <!-- diisi via JS -->
      </div>

      <!-- semua bulan (disembunyikan default) -->
      <div id="janjiImanAll" class="space-y-3 mt-4 hidden">
        <!-- diisi via JS -->
      </div>
    </section>
	  
    <!-- Rincian Bulanan -->
    <section class="rounded-3xl p-5 bg-[var(--glass)] backdrop-blur ring-1" style="--tw-ring-color:var(--ring);">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Rincian Bulanan</h2>
        <button onclick="openModal()"
                class="px-4 py-2 rounded-xl bg-indigo-400 hover:bg-indigo-300 text-slate-800 text-sm font-semibold transition">
          Donasi
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-slate-600">
            <tr>
              <th class="text-left py-2 pr-4">Bulan</th>
              <th class="text-right py-2 pr-4">Persembahan Pembangunan SM</th>
              <th class="text-right py-2 pr-4">Persembahan Lewat Transfer</th>
		      <th class="text-right py-2 pr-4">Janji Iman</th>
              <th class="text-right py-2 pr-4">Total</th>
            </tr>
          </thead>
          <tbody id="listBulanan" class="divide-y divide-slate-200/70"></tbody>
        </table>
      </div>
    </section>

  </main>

  <footer class="relative max-w-6xl mx-auto p-6 text-xs text-slate-500">
    © 2025 — Penggalangan Dana
  </footer>

  <!-- Modal Donasi -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full text-center shadow-xl">
      <h3 class="text-lg font-bold mb-3">Informasi Donasi</h3>
      <p class="text-sm text-slate-600 mb-3">Rekening pembangunan gedung sekolah minggu</p>
      <div class="font-semibold text-lg mb-4">
        Ac. 1373554433
	<br>An. Gbi bethel indonesia
	<br>Bca kcp lembang

      </div>
      <p class="text-xs text-slate-600 mb-4">
        Untuk berdonasi, silakan transfer sesuai kerelaan hati.
        Setelah transfer, konfirmasi ke panitia agar tercatat.
      </p>
      <button onclick="closeModal()" class="mt-3 px-4 py-2 rounded-lg bg-slate-700 text-white hover:bg-slate-600">Tutup</button>
    </div>
  </div>

  <script>
        const DB_URL = "https://datatransfer-eb687-default-rtdb.asia-southeast1.firebasedatabase.app/GBISMB34-19C7-4793-B72A-063F232F4C41"; 
    const bulanIndo = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

    const dec64 = s => atob(s);
    const rupiah = n => "Rp " + Number(n||0).toLocaleString("id-ID");
    const clampPct = v => isFinite(v) && v>0 ? Math.min(100, Math.max(0, v)) : 0;

    async function loadData(){
      const [meta, monthly] = await Promise.all([
        fetch(DB_URL + ".json").then(r=>r.json()).catch(()=>null),
        fetch(DB_URL + "/totals/monthly.json").then(r=>r.json()).catch(()=>null)
      ]);

      const ts = meta && meta.lastUpdated ? Number(meta.lastUpdated) : 0;
      const fmt = ts ? new Date(ts).toLocaleString("id-ID", { dateStyle:"medium", timeStyle:"short", hour12:false, timeZone:"Asia/Jakarta" }) : "-";
      document.getElementById("lastUpdate").textContent = `Terakhir diperbarui: ${fmt}`;

      const danaTotal = meta?.danaDiperlukan ? Number(dec64(meta.danaDiperlukan)) : 0;
      const target    = meta?.targetPertama ? Number(dec64(meta.targetPertama))   : 0;

      // hitung total masuk dari monthly
      let totalMasuk = 0;
      let rows = [];
      if (monthly) {
        // urutkan kunci YYYY-MM
        const keys = Object.keys(monthly).sort(); // naik
        for (const k of keys) {
          const [y, m] = k.split("-");

          const pir = monthly[k].PIR ? Number(dec64(monthly[k].PIR)) : 0;
          const trf = monthly[k].Transfer ? Number(dec64(monthly[k].Transfer)) : 0;

          // Janji Iman (realisasi)
          const jiRaw = monthly[k].JanjiIman ? dec64(monthly[k].JanjiIman) : "0";
          const ji = Number(jiRaw) || 0;

          // Target Janji Iman (bisa ada "++" di belakang)
          const targetJiRaw = monthly[k].TargetJanjiIman ? dec64(monthly[k].TargetJanjiIman) : "0";
          // ambil angka depannya saja untuk hitung persen
          const targetJiNum = parseInt(targetJiRaw, 10) || 0;
          const targetJiHasPlus = targetJiRaw.includes("++");

          const subtotal = pir + trf + ji;
          totalMasuk += subtotal;

          rows.push({
            y: Number(y),
            m: Number(m),
            label: `${bulanIndo[Number(m) - 1]} ${y}`,
            pir,
            trf,
            ji,
            jiTarget: targetJiNum,
            jiTargetPlus: targetJiHasPlus,
            subtotal
          });
        }
      }


      // ringkasan angka
      document.getElementById("danaTotal").innerText   = rupiah(danaTotal);
      document.getElementById("totalMasuk").innerText  = rupiah(totalMasuk);
      document.getElementById("kekurangan").innerText  = rupiah((danaTotal||0) - (totalMasuk||0));
      document.getElementById("targetPertama").innerText = rupiah(target);

      // progres total
      const pctTotal = clampPct(danaTotal>0 ? (totalMasuk/danaTotal*100) : 0);
      document.getElementById("totalPctText").innerText = pctTotal.toFixed(2) + "%";
      document.getElementById("totalBar").style.width   = pctTotal + "%";
      document.getElementById("totalCaption").innerText = `${rupiah(totalMasuk)} dari ${rupiah(danaTotal)}`;

      // progres target pertama
      const pctTarget = clampPct(target>0 ? (totalMasuk/target*100) : 0);
      document.getElementById("targetPctText").innerText = pctTarget.toFixed(2) + "%";
      document.getElementById("targetBar").style.width   = pctTarget + "%";
      document.getElementById("targetCaption").innerText = `${rupiah(totalMasuk)} dari ${rupiah(target)}`;

      // tabel bulanan
      const tbody = document.getElementById("listBulanan");
      tbody.innerHTML = "";
      rows.forEach(r=>{
        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="py-2 pr-4 text-right">${r.label}</td>
            <td class="py-2 pr-4 text-right">${rupiah(r.pir)}</td>
            <td class="py-2 pr-4 text-right">${rupiah(r.trf)}</td>
			 <td class="py-2 pr-4 text-right">${rupiah(r.ji)}</td>
            <td class="py-2 pr-4 text-right font-semibold">${rupiah(r.subtotal)}</td>
          </tr>
        `);
      });
    }

	  // Progres Janji Iman (show/hide, default hanya bulan terakhir)
      const jiSection    = document.getElementById("janjiImanSection");
      const jiSingleEl   = document.getElementById("janjiImanSingle");
      const jiAllEl      = document.getElementById("janjiImanAll");
      const jiToggleBtn  = document.getElementById("btnToggleJanjiIman");
      const jiToggleText = document.getElementById("janjiImanToggleText");
      const jiToggleIcon = document.getElementById("janjiImanToggleIcon");

      if (jiSection && jiSingleEl && jiAllEl) {
        // hanya baris yang punya Janji Iman / target
        const jiRows = rows.filter(r => (r.ji > 0) || (r.jiTarget || 0) > 0);

        if (!jiRows.length) {
          jiSection.classList.add("hidden");
        } else {
          // bulan terakhir
          const lastJi = jiRows[jiRows.length - 1];
          const pctLast = clampPct(
            lastJi.jiTarget > 0 ? (lastJi.ji / lastJi.jiTarget * 100) : 0
          );

          const lastTargetLabel =
            `${rupiah(lastJi.jiTarget)}${lastJi.jiTargetPlus ? "++" : ""}`;

          jiSingleEl.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium text-sm">${lastJi.label}</div>
                <div class="text-[11px] text-slate-500">
                  ${rupiah(lastJi.ji)} dari ${lastTargetLabel}
                </div>
              </div>
              <div class="text-xs font-semibold text-slate-700">
                ${pctLast.toFixed(2)}%
              </div>
            </div>
            <div class="w-full h-2 rounded-full bg-slate-200/70 overflow-hidden mt-2">
              <div class="h-2 rounded-full bg-rose-300" style="width:${pctLast}%;"></div>
            </div>
          `;

          // semua bulan
          let allHtml = "";
          jiRows.forEach(r => {
            const pct = clampPct(
              r.jiTarget > 0 ? (r.ji / r.jiTarget * 100) : 0
            );
            const targetLabel =
              `${rupiah(r.jiTarget)}${r.jiTargetPlus ? "++" : ""}`;

            allHtml += `
              <div class="pt-2 border-t border-slate-200/60">
                <div class="flex items-center justify-between">
                  <div class="text-xs">${r.label}</div>
                  <div class="text-[11px] text-slate-600">${pct.toFixed(2)}%</div>
                </div>
                <div class="w-full h-1.5 rounded-full bg-slate-200/70 overflow-hidden mt-1">
                  <div class="h-1.5 rounded-full bg-rose-300" style="width:${pct}%;"></div>
                </div>
                <div class="mt-1 text-[11px] text-slate-500">
                  ${rupiah(r.ji)} dari ${targetLabel}
                </div>
              </div>
            `;
          });
          jiAllEl.innerHTML = allHtml;

          // toggle show/hide
          if (jiToggleBtn && jiToggleText && jiToggleIcon) {
            jiToggleBtn.addEventListener("click", () => {
              const isHidden = jiAllEl.classList.contains("hidden");
              jiAllEl.classList.toggle("hidden");
              jiToggleText.textContent = isHidden
                ? "Sembunyikan bulan lain"
                : "Tampilkan semua bulan";
              jiToggleIcon.classList.toggle("rotate-180", isHidden);
            });
          }
        }
      }
	  
    function openModal(){ const m=document.getElementById("modal"); m.classList.remove("hidden"); m.classList.add("flex"); }
    function closeModal(){ const m=document.getElementById("modal"); m.classList.add("hidden"); m.classList.remove("flex"); }

    document.addEventListener("DOMContentLoaded", loadData);
  </script>
</body>
</html>




